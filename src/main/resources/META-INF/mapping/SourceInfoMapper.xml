<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.phxl.ysy.dao.SourceInfoMapper">

	<resultMap id="BaseResultMap" type="com.phxl.ysy.entity.SourceInfo">
		<id column="SOURCE_GUID" property="sourceGuid" jdbcType="VARCHAR" />
		<result column="F_ORG_ID" property="fOrgId" jdbcType="DECIMAL" />
		<result column="R_ORG_ID" property="rOrgId" jdbcType="DECIMAL" />
		<result column="R_STORAGE_GUID" property="rStorageGuid" jdbcType="VARCHAR" />
		<result column="FSTATE" property="fstate" jdbcType="VARCHAR" />
		<result column="CREATE_USERID" property="createUserid" jdbcType="VARCHAR" />
		<result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
		<result column="MODIFY_TIME" property="modifyTime" jdbcType="TIMESTAMP" />
		<result column="MODIFY_USERID" property="modifyUserid" jdbcType="VARCHAR" />
		<result column="KING_ORG_ID" property="kingOrgId" jdbcType="DECIMAL" />
		<result column="SUPPLIER_CODE" property="supplierCode" jdbcType="VARCHAR" />
		<result column="TF_REMARK" property="tfRemark" jdbcType="VARCHAR" />
		<result column="LXR" property="lxr" jdbcType="VARCHAR" />
		<result column="LXDH" property="lxdh" jdbcType="VARCHAR" />
	</resultMap>
	
	<sql id="Base_Column_List">
		SOURCE_GUID, F_ORG_ID, R_ORG_ID,R_STORAGE_GUID , FSTATE, CREATE_USERID, CREATE_TIME,
		MODIFY_TIME, MODIFY_USERID, KING_ORG_ID, SUPPLIER_CODE,LXR,LXDH,TF_REMARK 
	</sql>
	
	<!-- 查询指定机构的供应商列表 -->
	<select id="findMySupplierList" resultMap="SOURCE_SUPPLIER_RESULTMAP" parameterType="com.phxl.core.base.entity.Pager">
		<include refid="findMySupplierList_SQL"></include>
		WHERE 
			si.R_ORG_ID = #{conditiions.sessionOrgId, jdbcType=DECIMAL}
			<if test="conditiions!=null and !conditiions.empty">
				<if test="conditiions.orgName!=null and conditiions.orgName!=''">
					and regexp_like(f.ORG_NAME, #{conditiions.orgName, jdbcType=VARCHAR})
				</if>
				<if test="conditiions.orgAlias!=null and conditiions.orgAlias!=''">
					and regexp_like(f.ORG_ALIAS, #{conditiions.orgAlias, jdbcType=VARCHAR})
				</if>
				<if test="conditiions.fqun!=null and conditiions.fqun!=''">
					and regexp_like(f.FQUN, upper(#{conditiions.fqun, jdbcType=VARCHAR}))
				</if>
				<if test="conditiions.supplierCode!=null and conditiions.supplierCode!=''">
					and regexp_like(si.SUPPLIER_CODE, #{conditiions.supplierCode, jdbcType=VARCHAR})
				</if>
				<if test="conditiions.fstate!=null and conditiions.fstate!=''">
					and f.FSTATE = #{conditiions.fstate, jdbcType=VARCHAR}
				</if>
			</if>
		
		<!-- 排序 -->
		<choose>
			<when test="conditiions != null and conditiions.orderMark != null and conditiions.orderField != null and conditiions.orderField!=''">
				order by [orderField] ${conditiions.orderMark}
			</when>
			<otherwise>
				order by nvl(MODIFY_TIME,CREATE_TIME) desc
			</otherwise>
		</choose>
	</select>
	
	<select id="findMySourceInfoList" resultType="java.util.LinkedHashMap" parameterType="com.phxl.core.base.entity.Pager">
		select t.source_guid "sourceGuid",t.r_org_id "rOrgId",t.f_org_id "fOrgId",t.r_storage_guid "storageGuid",s.storage_name "storageName",t.fstate "fstate",u.user_name "createUsername",to_char(t.create_time,'yyyy-MM-dd') "createTime",
		       t.supplier_code "supplierCode",o.org_name "forgName",t.lxr "lxr",t.lxdh "lxdh",
		       case when t.king_org_id is not null and t.king_org_id = t.f_org_id then '1' else '0' end as "isSupplierKing"
		from tb_source_info t
		left join td_storage_info s on s.storage_guid = t.r_storage_guid
		left join ts_user_info u on u.user_id = t.create_userid
		left join td_org_info o on o.org_id = t.f_org_id
		where t.r_org_id = #{conditiions.sessionOrgId, jdbcType=DECIMAL}
		<if test="conditiions!=null and !conditiions.empty">
			<if test="conditiions.storageGuid!=null and conditiions.storageGuid!=''">
				and t.r_storage_guid = #{conditiions.storageGuid, jdbcType=VARCHAR}
			</if>
			<if test="conditiions.searchName!=null and conditiions.searchName!=''">
				and( regexp_like(o.org_name, #{conditiions.searchName, jdbcType=VARCHAR}) or regexp_like(t.supplier_code, #{conditiions.searchName, jdbcType=VARCHAR}) 
				    or regexp_like(t.lxr, #{conditiions.searchName, jdbcType=VARCHAR}))
			</if>
			<if test="conditiions.fstate!=null and conditiions.fstate!=''">
				and f.FSTATE = #{conditiions.fstate, jdbcType=VARCHAR}
			</if>
		</if>
		
		<!-- 排序 -->
		<choose>
			<when test="conditiions != null and conditiions.orderMark != null and conditiions.orderField != null and conditiions.orderField!=''">
				order by [orderField] ${conditiions.orderMark}
			</when>
			<otherwise>
				order by nvl(t.MODIFY_TIME,t.CREATE_TIME) desc
			</otherwise>
		</choose>
	</select>
	
	<!-- 根据sourceId查询供应商信息 -->
	<select id="findMySupplierBySourceId" resultMap="SOURCE_SUPPLIER_RESULTMAP" parameterType="com.phxl.core.base.entity.Pager">
		<include refid="findMySupplierList_SQL"></include>
		WHERE si.R_ORG_ID = #{sessionOrgId}
		and si.SOURCE_GUID = #{sourceId}
	</select>
	
	<!-- 我的供需商信息结果映射 -->
	<resultMap id="SOURCE_SUPPLIER_RESULTMAP" type="java.util.LinkedHashMap">
		<id column="SOURCE_GUID" property="sourceGuid" jdbcType="VARCHAR" />
		<result column="R_ORG_ID" property="rOrgId" jdbcType="DECIMAL" />
		<result column="F_ORG_ID" property="fOrgId" jdbcType="DECIMAL" />
		<result column="STORAGE_GUID" property="storageGuid" jdbcType="VARCHAR" />
		<result column="FSTATE" property="fstate" jdbcType="VARCHAR" />
		<result column="CREATE_USERNAME" property="createUsername" jdbcType="VARCHAR" />
		<result column="MODIFY_USERNAME" property="modifyUsername" jdbcType="VARCHAR" />
		<result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
		<result column="MODIFY_TIME" property="modifyTime" jdbcType="TIMESTAMP" />
		<result column="KING_ORG_ID" property="kingOrgid" jdbcType="DECIMAL" />
		<result column="SUPPLIER_CODE" property="supplierCode" jdbcType="VARCHAR" />
		<result column="TF_REMARK" property="tfRemark" jdbcType="VARCHAR" />
		<result column="ORG_ID" property="orgId" jdbcType="DECIMAL" />
		<result column="ORG_CODE" property="orgCode" jdbcType="VARCHAR" />
		<result column="ORG_NAME" property="orgName" jdbcType="VARCHAR" />
		<result column="FQUN" property="fqun" jdbcType="VARCHAR" />
		<result column="ORG_ALIAS" property="orgAlias" jdbcType="VARCHAR" />
		<result column="TF_PROVINCE" property="tfProvince" jdbcType="VARCHAR" />
		<result column="TF_CITY" property="tfCity" jdbcType="VARCHAR" />
		<result column="TF_DISTRICT" property="tfDistrict" jdbcType="VARCHAR" />
		<result column="TF_ADDRESS" property="tfAddress" jdbcType="VARCHAR" />
		<result column="TF_BANK" property="tfBank" jdbcType="VARCHAR" />
		<result column="BANK_ACCOUNT" property="bankAccount" jdbcType="VARCHAR" />
		<result column="WEBSITE" property="website" jdbcType="VARCHAR" />
		<result column="SUPPLIER_FSTATE" property="supplierFstate" jdbcType="VARCHAR" />
		<result column="TF_LOGO" property="tfLogo" jdbcType="VARCHAR" />
		<result column="TF_PROFILE" property="tfProfile" jdbcType="VARCHAR" />
		<result column="ORG_TYPE" property="orgType" jdbcType="VARCHAR" />
		<result column="PARENT_ORGID" property="parentOrgid" jdbcType="DECIMAL" />
		<result column="PARENT_ORG_NAME" property="parentOrgName" jdbcType="VARCHAR" />
		<result column="FLAG" property="flag" jdbcType="VARCHAR" />
		<result column="LXR" property="lxr" jdbcType="VARCHAR" />
		<result column="LXDH" property="lxdh" jdbcType="VARCHAR" />
		<result column="ORG_STATUS" property="orgStatus" jdbcType="VARCHAR" />
		<result column="BAD_NEWS_FIRST" property="badNewsFirst" jdbcType="VARCHAR" />
		<result column="BAD_NEWS_SECOND" property="badNewsSecond" jdbcType="VARCHAR" />
		<result column="VIP_LEVEL" property="vipLevel" jdbcType="VARCHAR" />
		<result column="LEGAL_MAN" property="legalMan" jdbcType="VARCHAR" />
		<result column="REGISTERED_CAPITAL" property="registeredCapital" jdbcType="VARCHAR" />
		<result column="INCOME_CAPITAL" property="incomeCapital" jdbcType="VARCHAR" />
		<result column="CORPORATION_TYPE" property="corporationType" jdbcType="VARCHAR" />
		<result column="RMB_AMOUNT" property="rmbAmount" jdbcType="VARCHAR" />
		<result column="YYZZ_PATH" property="yyzzPath" jdbcType="VARCHAR" />
		<result column="JGDMZ_PATH" property="jgdmzPath" jdbcType="VARCHAR" />
		<result column="SWDJ_PATH" property="swdjPath" jdbcType="VARCHAR" />
		<result column="SCXK_PATH" property="scxkPath" jdbcType="VARCHAR" />
		<result column="JYXK_PATH" property="jyxkPath" jdbcType="VARCHAR" />
		<result column="STORAGE_ID" property="storageId" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="findMySupplierList_SQL">
		SELECT 
			<!-- 供需信息 -->
			si.SOURCE_GUID, si.F_ORG_ID, si.R_ORG_ID, si.FSTATE, u1.USER_NAME CREATE_USERNAME, si.CREATE_TIME,
			si.MODIFY_TIME, u1.USER_NAME  MODIFY_USERNAME, si.KING_ORG_ID, si.SUPPLIER_CODE, si.TF_REMARK,
			<!-- 供应商信息 -->
			f.ORG_ID, f.ORG_CODE, f.ORG_NAME, f.FQUN, f.ORG_ALIAS, f.TF_PROVINCE, f.TF_CITY, f.TF_DISTRICT, f.TF_ADDRESS, 
			f.TF_BANK, f.BANK_ACCOUNT, f.WEBSITE, f.FSTATE SUPPLIER_FSTATE, f.TF_LOGO, f.TF_PROFILE, f.ORG_TYPE, 
			f.PARENT_ORGID, pf.ORG_NAME PARENT_ORG_NAME, f.FLAG, f.LXR, f.LXDH, f.ORG_STATUS, 
			f.BAD_NEWS_FIRST, f.BAD_NEWS_SECOND, f.VIP_LEVEL, f.LEGAL_MAN, 
	    	<!-- f.CREATE_USERID, f.CREATE_TIME, f.MODIFY_TIME, f.TF_REMARK,  -->
	    	s.REGISTERED_CAPITAL, s.INCOME_CAPITAL, nvl(sd.TF_CLO_NAME, s.CORPORATION_TYPE) CORPORATION_TYPE, s.RMB_AMOUNT,
	    	<!-- 供应商资质证件 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO WHERE ORG_ID=si.F_ORG_ID AND CERT_CODE='1' and ROWNUM=1) YYZZ_PATH,		<!-- 企业法人营业执照 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO WHERE ORG_ID=si.F_ORG_ID AND CERT_CODE='2' and ROWNUM=1) JGDMZ_PATH,	<!-- 组织机构代码证 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO  WHERE ORG_ID=si.F_ORG_ID AND CERT_CODE='10' and ROWNUM=1) SWDJ_PATH,	<!-- 税务登记证 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO WHERE ORG_ID=si.F_ORG_ID AND CERT_CODE='3' and ROWNUM=1) SCXK_PATH,		<!-- 医疗器械生产企业许可证 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO WHERE ORG_ID=si.F_ORG_ID AND CERT_CODE='4' and ROWNUM=1) JYXK_PATH,		<!-- 医疗器械经营企业许可证 -->
			<!-- 库房信息，待库房功能开始以后完善 -->
			'库房编号' storage_id
		FROM  TB_SOURCE_INFO si
		LEFT JOIN TD_ORG_INFO f on si.F_ORG_ID=f.ORG_ID
		LEFT JOIN TD_ORG_INFO pf on f.PARENT_ORGID = pf.ORG_ID
		LEFT JOIN TD_SUPPLIER_INFO s on si.F_ORG_ID=s.ORG_ID
		left join TD_STATIC_DATA sd on sd.TF_CLO_NAME='CORPORATION_TYPE' and sd.TF_CLO_CODE=s.CORPORATION_TYPE
		LEFT JOIN TS_USER_INFO u1 on si.CREATE_USERID=u1.USER_ID
		LEFT JOIN TS_USER_INFO u2 on si.MODIFY_USERID=u2.USER_ID
	</sql>
	
	<resultMap id="OrgInfoExtResultMap" type="java.util.LinkedHashMap" extends="com.phxl.ysy.dao.OrgInfoMapper.BaseResultMap">
		<result column="PARENT_ORG_NAME" property="parentOrgName" jdbcType="VARCHAR" />
		<result column="REGISTERED_CAPITAL" property="registeredCapital" jdbcType="VARCHAR" />
		<result column="INCOME_CAPITAL" property="incomeCapital" jdbcType="VARCHAR" />
		<result column="CORPORATION_TYPE" property="corporationType" jdbcType="VARCHAR" />
		<result column="RMB_AMOUNT" property="rmbAmount" jdbcType="VARCHAR" />
		<result column="YYZZ_PATH" property="yyzzPath" jdbcType="VARCHAR" />
		<result column="JGDMZ_PATH" property="jgdmzPath" jdbcType="VARCHAR" />
		<result column="SWDJ_PATH" property="swdjPath" jdbcType="VARCHAR" />
		<result column="SCXK_PATH" property="scxkPath" jdbcType="VARCHAR" />
		<result column="JYXK_PATH" property="jyxkPath" jdbcType="VARCHAR" />
	</resultMap>
	
	<!-- 查询跟指定机构没有供需关系的供应商的列表 -->
	<select id="findUnsourceOrgList" resultMap="OrgInfoExtResultMap" parameterType="com.phxl.core.base.entity.Pager">
		SELECT
			<!-- 供应商信息 -->
			<include refid="com.phxl.ysy.dao.OrgInfoMapper.Base_Column_List_With_Prefix"></include>
			, pf.ORG_NAME PARENT_ORG_NAME,
			s.REGISTERED_CAPITAL, s.INCOME_CAPITAL, nvl(sd.TF_CLO_NAME, s.CORPORATION_TYPE) CORPORATION_TYPE, s.RMB_AMOUNT,
			<!-- 供应商资质证件 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO WHERE ORG_ID=o.ORG_ID AND CERT_CODE='1' and ROWNUM=1) YYZZ_PATH,		<!-- 企业法人营业执照 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO WHERE ORG_ID=o.ORG_ID AND CERT_CODE='2' and ROWNUM=1) JGDMZ_PATH,	<!-- 组织机构代码证 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO  WHERE ORG_ID=o.ORG_ID AND CERT_CODE='10' and ROWNUM=1) SWDJ_PATH,	<!-- 税务登记证 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO WHERE ORG_ID=o.ORG_ID AND CERT_CODE='3' and ROWNUM=1) SCXK_PATH,		<!-- 医疗器械生产企业许可证 -->
			(SELECT TF_ACCESSORY_FILE from TD_CERT_INFO WHERE ORG_ID=o.ORG_ID AND CERT_CODE='4' and ROWNUM=1) JYXK_PATH		<!-- 医疗器械经营企业许可证 -->
		FROM TD_ORG_INFO o
		LEFT JOIN TD_SUPPLIER_INFO s on o.ORG_ID=s.ORG_ID
		LEFT JOIN TD_ORG_INFO pf on o.PARENT_ORGID = pf.ORG_ID
		left join TD_STATIC_DATA sd on sd.TF_CLO_NAME='CORPORATION_TYPE' and sd.TF_CLO_CODE=s.CORPORATION_TYPE
		WHERE 
			o.ORG_TYPE='02' <!-- 02供应商 -->
			and not exists(
				SELECT si.F_ORG_ID FROM TB_SOURCE_INFO si WHERE si.R_ORG_ID=#{conditiions.sessionOrgId, jdbcType=DECIMAL} and si.F_ORG_ID=o.ORG_ID
			)
			<if test="conditiions!=null and !conditiions.empty">
				<if test="conditiions.searchName!=null and conditiions.searchName!=''">
					and (	regexp_like(o.ORG_NAME, #{conditiions.searchName, jdbcType=VARCHAR})
						or regexp_like(o.ORG_ALIAS, #{conditiions.searchName, jdbcType=VARCHAR})
						or regexp_like(o.FQUN, upper(#{conditiions.searchName, jdbcType=VARCHAR})) )
				</if>
			</if>
			
		<!-- 排序 -->
		<choose>
			<when test="conditiions != null and conditiions.orderMark != null and conditiions.orderField != null and conditiions.orderField!=''">
				order by [orderField] ${conditiions.orderMark}
			</when>
			<otherwise>
				order by ORG_NAME asc  
			</otherwise>
		</choose>
	</select>

	<sql id="findMyHospitalList_SQL">
		SELECT 
			<!-- 供需信息 -->
	    	si.SOURCE_GUID, si.F_ORG_ID, si.R_ORG_ID, si.FSTATE,
			<!-- 医院信息 -->
			r.ORG_ID, r.ORG_CODE, r.ORG_NAME, r.FQUN, r.ORG_ALIAS, r.TF_PROVINCE, r.TF_CITY, r.TF_DISTRICT 
	    	<!-- 库房信息，待库房功能开始以后完善 -->
		FROM  TB_SOURCE_INFO si
		LEFT JOIN TD_ORG_INFO r on si.R_ORG_ID=r.ORG_ID
	</sql>
	
	<!-- 查询指定机构的医院列表 -->
	<select id="findMyHospitalList" resultMap="SOURCE_SUPPLIER_RESULTMAP" parameterType="com.phxl.core.base.entity.Pager">
		<include refid="findMyHospitalList_SQL"></include>
		WHERE 
			si.F_ORG_ID = #{conditiions.sessionOrgId, jdbcType=DECIMAL}
			<if test="conditiions!=null and !conditiions.empty">
				<if test="conditiions.searchParams!=null and conditiions.searchParams!=''">
					and (
						regexp_like(r.ORG_NAME, #{conditiions.searchParams, jdbcType=VARCHAR})
						or regexp_like(r.ORG_ALIAS, #{conditiions.searchParams, jdbcType=VARCHAR})		
						or regexp_like(r.FQUN, #{conditiions.searchParams, jdbcType=VARCHAR})
					)
				</if>
			</if>
		
		<!-- 排序 -->
		<choose>
			<when test="conditiions != null and conditiions.orderMark != null and conditiions.orderField != null and conditiions.orderField!=''">
				order by [orderField] ${conditiions.orderMark}
			</when>
			<otherwise>
				order by ORG_NAME asc 
			</otherwise>
		</choose>
	</select>
	
	<!-- 检查供应商编码是否已占用 -->
	<select id="existSupplierCode" resultType="int">
		SELECT count(*) from TB_SOURCE_INFO si WHERE si.R_ORG_ID = #{rOrgId} and si.SUPPLIER_CODE = #{supplierCode}
		<if test="excludeSourceId!=null and excludeSourceId!=''">
			and SOURCE_GUID != #{excludeSourceId}
		</if>
	</select>

	<!-- 批量编辑供需关系状态-->
	<update id="updateFstateBatch">
		update TB_SOURCE_INFO 
		set FSTATE = #{fstate, jdbcType=VARCHAR},
			 MODIFY_USERID = #{modifyUserid, jdbcType=VARCHAR},
			 MODIFY_TIME = sysdate
		where SOURCE_GUID in 
			(select TB_SOURCE_INFO.SOURCE_GUID from TB_SOURCE_INFO where TB_SOURCE_INFO.Fstate = '01' and (TB_SOURCE_INFO.F_ORG_ID = #{orgId, jdbcType=DECIMAL} or TB_SOURCE_INFO.r_Org_Id = #{orgId, jdbcType=DECIMAL}))
	</update>
	
	<select id="findSourceListForSelect" resultType="hashMap">
		SELECT o.org_id "value",o.org_name "text"
		from TB_SOURCE_INFO si
		<if test="conditiions.rOrgId!=null and conditiions.rOrgId!=''">
			left join td_org_info o on si.f_org_id = o.org_id
		</if>
		<if test="conditiions.fOrgId!=null and conditiions.fOrgId!=''">	
			left join td_org_info o on si.r_org_id = o.org_id
		</if>
		<where>
			<if test="conditiions.fOrgId!=null and conditiions.fOrgId!=''">
				and si.f_org_id = #{conditiions.fOrgId}
			</if>
			<if test="conditiions.rOrgId!=null and conditiions.rOrgId!=''">
				and si.r_org_id = #{conditiions.rOrgId}
			</if>
			<if test="conditiions.searchName!=null and conditiions.searchName!=''">
				and regexp_like(o.org_name, #{conditiions.searchName, jdbcType=VARCHAR})

		    </if>
		</where>
	</select>
	
	<select id="queryRSourceStorageForSelect" resultType="hashMap">
		SELECT sg.storage_guid "value",si.r_org_id "rOrgId", o.org_name || sg.storage_name "text"
		from TB_SOURCE_INFO si
		left join td_storage_info sg on si.r_storage_guid = sg.storage_guid
		left join td_org_info o on si.r_org_id = o.org_id
		<where>
			<if test="conditiions.fOrgId!=null and conditiions.fOrgId!=''">
				and si.f_org_id = #{conditiions.fOrgId}
			</if>
			<if test="conditiions.searchName!=null and conditiions.searchName!=''">
				and (
						regexp_like(o.org_name, #{conditiions.searchName, jdbcType=VARCHAR})
					or 	regexp_like(sg.storage_name, #{conditiions.searchName, jdbcType=VARCHAR})
					)

		    </if>
		</where>
	</select>
</mapper>