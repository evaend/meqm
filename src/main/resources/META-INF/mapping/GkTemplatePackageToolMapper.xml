<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.phxl.ysy.dao.GkTemplatePackageToolMapper" >
  <resultMap id="BaseResultMap" type="com.phxl.ysy.entity.GkTemplatePackageTool" >
    <id column="GK_PACKAGE_TOOL_GUID" property="gkPackageToolGuid" jdbcType="VARCHAR" />
    <result column="GK_TEMPLATE_PACKAGE_GUID" property="gkTemplatePackageGuid" jdbcType="DECIMAL" />
    <result column="TF_AMOUNT" property="tfAmount" jdbcType="DECIMAL" />
    <result column="TOOL_CODE" property="toolCode" jdbcType="VARCHAR" />
    <result column="TOOL_NAME" property="toolName" jdbcType="VARCHAR" />
    <result column="GK_TEMPLATE_GUID" property="gkTemplateGuid" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    GK_PACKAGE_TOOL_GUID, GK_TEMPLATE_PACKAGE_GUID, TF_AMOUNT, TOOL_CODE, TOOL_NAME, 
    GK_TEMPLATE_GUID
  </sql>
  
  <resultMap id="BaseResultExtMap" type="com.phxl.ysy.entity.GkTemplatePackageTool" extends="BaseResultMap">
		<result column="IS_SELECTED" property="isSelected" jdbcType="DECIMAL" javaType="boolean"/>
	</resultMap>
  <!-- 查询指定包的工具列表（已选、未选） -->
	<select id="findAllTools" resultMap="BaseResultExtMap" parameterType="com.phxl.core.base.entity.Pager">
		select 
			tpt.GK_PACKAGE_TOOL_GUID GK_PACKAGE_TOOL_GUID, tpt.GK_TEMPLATE_GUID, tpt.PACKAGE_ID, 
			nvl(tpt.TOOL_CODE, tsd.TF_CLO_CODE) TOOL_CODE, tpt.TF_AMOUNT, 
			nvl(tpt.TOOL_NAME, tsd.TF_CLO_NAME) TOOL_NAME,
			case when tpt.GK_PACKAGE_TOOL_GUID is not null then 1 else 0 end IS_SELECTED
		from TB_GK_TEMPLATE_PACKAGE_TOOL tpt 
		right join TD_STATIC_DATA tsd 
			on tpt.GK_TEMPLATE_GUID=#{conditiions.gkTemplateGuid,jdbcType=VARCHAR} and tpt.package_id=#{conditiions.packageId,jdbcType=DECIMAL} and tsd.TF_CLO_CODE=tpt.TOOL_CODE
		inner join TD_STATIC_INFO tsi on tsi.STATIC_ID=tsd.STATIC_ID and tsi.ORG_ID=#{conditiions.rOrgId, jdbcType=DECIMAL} and tsi.TF_CLO = 'ATTRIBUTE_TOOL'
		where 1=1 
			<if test="conditiions!=null and conditiions.toolNameLike != null and conditiions.toolNameLike != ''">
				and regexp_like(tsd.TF_CLO_NAME, #{conditiions.toolNameLike,jdbcType=VARCHAR})
			</if>
	</select>
	
	<!-- 指定手术包批量添加工具 -->
	<insert id="addToolsBatch">
		MERGE INTO TB_GK_TEMPLATE_PACKAGE_TOOL h
		  USING (
			SELECT GK_TEMPLATE_GUID, package_id, TOOL_CODE, sum(TF_AMOUNT) TF_AMOUNT,
					(
					SELECT tsd.TF_CLO_NAME
					from TD_STATIC_INFO tsi
					LEFT JOIN TD_STATIC_DATA tsd on tsi.STATIC_ID=tsd.STATIC_ID
					WHERE tsi.ORG_ID = #{rOrgId, jdbcType=DECIMAL} and tsi.TF_CLO = 'ATTRIBUTE_TOOL' and tsd.TF_CLO_CODE=TOOL_CODE
					) TOOL_NAME
			FROM (
			    <foreach collection="toolList" item="e" separator="union all">
			      select
				      #{gkTemplateGuid, jdbcType=VARCHAR} GK_TEMPLATE_GUID,
				      #{e.packageId, jdbcType=DECIMAL} PACKAGE_ID,
				      #{e.toolCode, jdbcType=VARCHAR} TOOL_CODE,
				      (
						SELECT tsd.TF_CLO_NAME
						from TD_STATIC_INFO tsi
						LEFT JOIN TD_STATIC_DATA tsd on tsi.STATIC_ID=tsd.STATIC_ID
						WHERE tsi.ORG_ID = #{rOrgId, jdbcType=DECIMAL} and tsi.TF_CLO = 'ATTRIBUTE_TOOL' and tsd.TF_CLO_CODE=#{e.toolCode, jdbcType=VARCHAR}
					  ) TOOL_NAME,
				      #{e.tfAmount, jdbcType=DECIMAL} TF_AMOUNT
			      from dual
			    </foreach>
			) GROUP BY GK_TEMPLATE_GUID, package_id, TOOL_CODE
		  ) hp ON (h.GK_TEMPLATE_GUID=hp.GK_TEMPLATE_GUID and h.PACKAGE_ID=hp.PACKAGE_ID and h.TOOL_CODE=hp.TOOL_CODE)
		WHEN MATCHED THEN UPDATE
		SET
		  h.TF_AMOUNT=hp.TF_AMOUNT,
		  h.TOOL_NAME=hp.TOOL_NAME
		WHEN NOT MATCHED THEN INSERT(GK_PACKAGE_TOOL_GUID, GK_TEMPLATE_GUID, PACKAGE_ID, TF_AMOUNT, TOOL_CODE, TOOL_NAME)
		VALUES (sys_guid(), hp.GK_TEMPLATE_GUID, hp.PACKAGE_ID, hp.TF_AMOUNT, hp.TOOL_CODE,hp.TOOL_NAME)
	</insert>
	
	<!-- 指定手术包删除多个工具 -->
	<delete id="deleteToolsByPackage">
		delete from TB_GK_TEMPLATE_PACKAGE_TOOL where GK_TEMPLATE_GUID=#{gkTemplateGuid,jdbcType=VARCHAR} and package_id=#{packageId,jdbcType=DECIMAL}
			and TOOL_CODE in 
			<foreach collection="toolList" item="item" open="(" close=")" separator=",">
				#{item,jdbcType=VARCHAR}
			</foreach>
	</delete>
	
	<!-- 查询指定手术包的工具数量 -->
	<select id="countToolsByPackage" resultType="java.lang.Integer">
		select sum(tf_amount) from TB_GK_TEMPLATE_PACKAGE_TOOL where GK_TEMPLATE_GUID=#{gkTemplateGuid,jdbcType=VARCHAR} and package_id=#{packageId,jdbcType=DECIMAL}
	</select>
	
	<delete id="deleteToolsByTemplateId">
	 	delete from TB_GK_TEMPLATE_PACKAGE_TOOL 
        where gk_template_guid = #{gkTemplateGuid}
	</delete>
</mapper>