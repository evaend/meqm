<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.phxl.ysy.dao.GkTemplateDetailMapper" >
  <resultMap id="BaseResultMap" type="com.phxl.ysy.entity.GkTemplateDetail" >
    <id column="GK_TEMPLATE_DETAIL_GUID" property="gkTemplateDetailGuid" jdbcType="VARCHAR" />
    <result column="GK_TEMPLATE_GUID" property="gkTemplateGuid" jdbcType="VARCHAR" />
    <result column="TENDER_DETAIL_GUID" property="tenderDetailGuid" jdbcType="VARCHAR" />
    <result column="TF_AMOUNT" property="tfAmount" jdbcType="DECIMAL" />
    <result column="FLOT" property="flot" jdbcType="VARCHAR" />
    <result column="PROD_DATE" property="prodDate" jdbcType="DATE" />
    <result column="USEFUL_DATE" property="usefulDate" jdbcType="DATE" />
    <result column="SAVE_FLAG" property="saveFlag" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    GK_TEMPLATE_DETAIL_GUID, GK_TEMPLATE_GUID, TENDER_DETAIL_GUID, TF_AMOUNT, FLOT, PROD_DATE, USEFUL_DATE, 
    SAVE_FLAG
  </sql>
  
  <!-- 统计汇总:产品列表各产品属性分布 -->
	<select id="subtotalOfAttributeIds" resultType="java.util.LinkedHashMap">
		select
		<foreach collection="gkAttributes" item="attr" index="index" separator=",">
			(	SELECT 
					nvl(sum(tdd.AMOUNT), 0)
				from (
					<foreach collection="gkTemplateDetails" item="m" separator="union all">
						select #{m.tenderDetailGuid,jdbcType=VARCHAR} tender_detail_guid, #{m.tf_amount,jdbcType=VARCHAR} amount from dual
					</foreach>
				) tdd
				LEFT JOIN TD_TENDER_DETAIL ttd on TDD.TENDER_DETAIL_GUID=TTD.TENDER_DETAIL_GUID
				LEFT JOIN TD_TENDER_INFO tti on ttd.tender_guid=tti.tender_guid 
				WHERE tti.ATTRIBUTE_ID=#{attr.TF_CLO_CODE,jdbcType=VARCHAR}
			) as "${attr.TF_CLO_CODE}"
		</foreach>
		from dual
	</select>
   <!-- 查询模版产品明细列表 -->
    <select id="searchGkTemplateDetails" resultType="java.util.HashMap" parameterType="com.phxl.core.base.entity.Pager">
    	SELECT
    	    distinct tpd.GK_TEMPLATE_DETAIL_GUID "gkTemplateDetailGuid",
    	    tpd.GK_TEMPLATE_GUID "gkTemplateGuid",
			tdi.TENDER_GUID "tenderGuid",
			tdi.R_ORG_ID "rOrgId",
			tdi.FITEMID "fitemid",
			tdd.CERT_GUID "certGuid",
			tdi.FBARCODE "fbarcode",
			tdi.ATTRIBUTE_ID "attributeId",
			tdi.TF_TEXTURE "tfTexture",
			tdi.PACKING_TEXTURE "packingTexture",
			tdi.TF_PACKING "tfPacking",
			tdd.fstate "fstate",
			tdi.GE_NAME "geName",
			tdi.GE_FQUN "geFqun",
			tdd.TENDER_DETAIL_GUID "tenderDetailGuid",
			tdd.TENDER_PRICE "tenderPrice",
			tdd.SOURCE_GUID "sourceGuid",
			tdd.TENDER_UNIT "tenderUnit",
			tdd.CONVERSION "tenderConversion",
			m.FMODEL "fmodel",
			m.SPEC "spec",
			m.MATERIAL_NAME "materialName",
			m.LEAST_UNIT "leastUnit",
			m.FBARCODE "tenderFbarcode",
			m.REF "ref",
			m.R_FITEMID_GUID "rFitemidGuid",
			r.FQUN "fqun",
			r.TYPE "type",
			r.REGISTER_NO "registerNo",
			r.FIRST_TIME "firstTime",
			r.LAST_TIME "lastTime",
			r.PRODUCE_NAME "produceName",
			r.TF_BRAND "tfBrand",
			r.FSTATE "registerFstate",
			r.FLAG "flag",
			si.F_ORG_ID "fOrgId",
			si.FSTATE "sourceFstate",
			si.SUPPLIER_CODE "supplierCode",
			tpd.TF_AMOUNT "tfAmount",
			tpd.FLOT "flot",
			to_char(tpd.PROD_DATE,'yyyy-MM-dd') "prodDate",
			to_char(tpd.USEFUL_DATE,'yyyy-MM-dd') "usefulDate",
			forg.ORG_NAME "fOrgName",
			brand2.TF_CLO_NAME "tfBrandName",
			gkattribute2.TF_CLO_NAME "attributeName"
		from tb_gk_template_detail tpd
		left join td_tender_detail tdd on tpd.TENDER_DETAIL_GUID = tdd.TENDER_DETAIL_GUID
		left join td_tender_info tdi on tdd.TENDER_GUID = tdi.TENDER_GUID
		left join td_material m on tdi.FITEMID = m.FITEMID
		left join td_register r on tdd.CERT_GUID = r.CERT_GUID
		left join tb_source_info si on si.SOURCE_GUID = tdd.SOURCE_GUID
		left join td_org_info forg on si.F_ORG_ID = forg.ORG_ID
		left join td_static_info brand on brand.TF_CLO='TF_BRAND'
		left join td_static_data brand2 on brand.STATIC_ID=brand2.STATIC_ID and brand2.TF_CLO_CODE=r.TF_BRAND
		left join td_static_info gkattribute on gkattribute.TF_CLO='GKATTRIBUTE' and gkattribute.ORG_ID = si.R_ORG_ID
		left join td_static_data gkattribute2 on gkattribute.STATIC_ID=gkattribute2.STATIC_ID and gkattribute2.TF_CLO_CODE=tdi.ATTRIBUTE_ID
	
		where 
			tdd.FSTATE = '01' 
			AND si.FSTATE = '01' 
			and forg.FSTATE = '01'
			<if test="conditiions!=null and !conditiions.empty">
				<if test="conditiions.gkTemplateGuid!=null and conditiions.gkTemplateGuid!=''">
					and tpd.GK_TEMPLATE_GUID = #{conditiions.gkTemplateGuid}
				</if>
				<if test="conditiions.gkTemplateGuids!=null and conditiions.gkTemplateGuids!=''">
					and tpd.GK_TEMPLATE_GUID  in 
			    		<foreach collection="conditiions.gkTemplateGuids" item="gkTemplateGuid" index="index" separator="," open="(" close=")">
					  		#{gkTemplateGuid}
					  	</foreach>
					and tpd.save_flag = '01'
				</if>
				<if test="conditiions.tfBrand!=null and conditiions.tfBrand!=''">
					and r.TF_BRAND = #{conditiions.tfBrand}
				</if>
				<if test="conditiions.attributeId!=null and conditiions.attributeId!=''">
					and tdi.ATTRIBUTE_ID = #{conditiions.attributeId}
				</if>
				<!-- 模糊搜索关键字（产品名称/通用名称/规格/型号） -->
				<if test="conditiions.searchName!=null and conditiions.searchName!=''">
					and (
							regexp_like(m.MATERIAL_NAME, #{conditiions.searchName, jdbcType=VARCHAR})
						or regexp_like(tdi.GE_NAME, #{conditiions.searchName, jdbcType=VARCHAR})
						or regexp_like(m.FMODEL, #{conditiions.searchName, jdbcType=VARCHAR})
						or regexp_like(m.SPEC, #{conditiions.searchName, jdbcType=VARCHAR})
					)
				</if>
			</if>
		<!-- 排序 -->
		order by m.MATERIAL_NAME, m.FMODEL, m.SPEC asc
    </select>
    
    <insert id="insertGkTemplateDetails">
      insert into TB_GK_TEMPLATE_DETAIL (GK_TEMPLATE_DETAIL_GUID, GK_TEMPLATE_GUID, 
      TENDER_DETAIL_GUID, TF_AMOUNT,SAVE_FLAG
      )
 	  SELECT 
			sys_guid(),product.GK_TEMPLATE_GUID,product.TENDER_DETAIL_GUID,1,'00'
		FROM (
		  	<foreach collection="tenderDetailGuids" item="tenderDetailGuid" index="index" separator="union all">
		  		SELECT #{gkTemplateGuid} GK_TEMPLATE_GUID,#{tenderDetailGuid, jdbcType=VARCHAR} TENDER_DETAIL_GUID FROM dual
		  	</foreach>
		  ) product
    </insert>
    
    <insert id="insertBatchGkTemplateDetails">
      insert into TB_GK_TEMPLATE_DETAIL(GK_TEMPLATE_DETAIL_GUID, GK_TEMPLATE_GUID, 
      TENDER_DETAIL_GUID, TF_AMOUNT, FLOT, PROD_DATE, USEFUL_DATE, SAVE_FLAG
      )
 	  SELECT 
			sys_guid(),#{gkTemplateGuid},product.TENDER_DETAIL_GUID,
			product.TF_AMOUNT,product.FLOT,product.PROD_DATE,product.USEFUL_DATE,
			product.SAVE_FLAG
		FROM (
		  	<foreach collection="newGkTemplateDetails" item="newGkTemplateDetail" index="index" separator="union all">
		  		SELECT  		
		  		#{newGkTemplateDetail.tenderDetailGuid, jdbcType=VARCHAR} TENDER_DETAIL_GUID, 
		  		#{newGkTemplateDetail.tfAmount, jdbcType=DECIMAL} TF_AMOUNT, 
		  		<choose>
			  		<when test="newGkTemplateDetail.flot != null">
			  			#{newGkTemplateDetail.flot} 
			  		</when>
			  		<otherwise>''</otherwise>
		  		</choose> FLOT,
		  		#{newGkTemplateDetail.prodDate, jdbcType=DATE} PROD_DATE, 
		  		#{newGkTemplateDetail.usefulDate, jdbcType=DATE} USEFUL_DATE,
		  		'00' SAVE_FLAG 		  		
		  		FROM dual
		  	</foreach>
		  ) product
    </insert>
    
    <delete id="deleteGkTemplateDetials">
    	delete from TB_GK_TEMPLATE_DETAIL
    	where GK_TEMPLATE_DETAIL_GUID in 
    		<foreach collection="gkTemplateDetailGuids" item="gkTemplateDetailGuid" index="index" separator="," open="(" close=")">
		  		#{gkTemplateDetailGuid}
		  	</foreach>
    </delete>
    
    <delete id="deleteGkDetailsByTemplateId">
         delete from TB_GK_TEMPLATE_DETAIL tpd
         where tpd.gk_template_guid = #{gkTemplate.gkTemplateGuid}
         <if test="notInGuidList != null and notInGuidList.size > 0">
         	 and tpd.GK_TEMPLATE_DETAIL_GUID not in
	         <foreach collection="notInGuidList" item="gkTemplateDetailGuid" index="index" separator="," open="(" close=")">
	         	#{gkTemplateDetailGuid}
	         </foreach>
         </if> 
         <if test="(gkTemplate.searchName != null and gkTemplate.searchName != '') or
         			(gkTemplate.tfBrand != null and gkTemplate.tfBrand != '') or
         			(gkTemplate.attributeId != null and gkTemplate.attributeId != '')">
         	and exists (
         		select 0 from td_tender_detail tdd 
							left join td_tender_info tdi on tdd.TENDER_GUID = tdi.TENDER_GUID
							left join td_material m on tdi.FITEMID = m.FITEMID
							left join td_register r on tdd.CERT_GUID = r.CERT_GUID
				where tpd.TENDER_DETAIL_GUID = tdd.TENDER_DETAIL_GUID
				<if test="gkTemplate.tfBrand!=null and gkTemplate.tfBrand!=''">
					and r.TF_BRAND = #{gkTemplate.tfBrand}
				</if>
				<if test="gkTemplate.attributeId!=null and gkTemplate.attributeId!=''">
					and tdi.ATTRIBUTE_ID = #{gkTemplate.attributeId}
				</if>
				<!-- 模糊搜索关键字（产品名称/通用名称/规格/型号） -->
				<if test="gkTemplate.searchName!=null and gkTemplate.searchName!=''">
					and (
							regexp_like(m.MATERIAL_NAME, #{gkTemplate.searchName, jdbcType=VARCHAR})
						or regexp_like(tdi.GE_NAME, #{gkTemplate.searchName, jdbcType=VARCHAR})
						or regexp_like(m.FMODEL, #{gkTemplate.searchName, jdbcType=VARCHAR})
						or regexp_like(m.SPEC, #{gkTemplate.searchName, jdbcType=VARCHAR})
					)
				</if>
         	)
         </if>      
    </delete>    
    
    <update id="updateGkTemplateDetails">
    	update TB_GK_TEMPLATE_DETAIL set
	    TF_AMOUNT=
	  <foreach collection="gkTemplateDetails" index="index" item="gkTemplateDetail" separator=" " open="case GK_TEMPLATE_DETAIL_GUID" close="end">
	      when #{gkTemplateDetail.gkTemplateDetailGuid,jdbcType=VARCHAR} then #{gkTemplateDetail.tfAmount,jdbcType=DECIMAL}
	  </foreach>
	  ,FLOT =
	  <foreach collection="gkTemplateDetails" index="index" item="gkTemplateDetail" separator=" " open="case GK_TEMPLATE_DETAIL_GUID" close="end">
	      when #{gkTemplateDetail.gkTemplateDetailGuid,jdbcType=VARCHAR} then #{gkTemplateDetail.flot,jdbcType=VARCHAR}
	  </foreach>
	  ,PROD_DATE =
	  <foreach collection="gkTemplateDetails" index="index" item="gkTemplateDetail" separator=" " open="case GK_TEMPLATE_DETAIL_GUID" close="end">
	      when #{gkTemplateDetail.gkTemplateDetailGuid,jdbcType=VARCHAR} then #{gkTemplateDetail.prodDate,jdbcType=DATE}
	  </foreach>
	  ,USEFUL_DATE =
	  <foreach collection="gkTemplateDetails" item="gkTemplateDetail" index="index" separator=" " open="case GK_TEMPLATE_DETAIL_GUID" close="end">
	      when #{gkTemplateDetail.gkTemplateDetailGuid,jdbcType=VARCHAR} then #{gkTemplateDetail.usefulDate,jdbcType=DATE}
	  </foreach>
	  where GK_TEMPLATE_DETAIL_GUID in
	  <foreach collection="gkTemplateDetails" index="index" item="gkTemplateDetail" separator="," open="(" close=")">
	      #{gkTemplateDetail.gkTemplateDetailGuid,jdbcType=VARCHAR}
	  </foreach>    
    </update>
    
    <update id="updateDetailsToFormal">
	    update TB_GK_TEMPLATE_DETAIL 
	    set save_flag = '01'
	    where gk_template_guid = #{gkTemplateGuid}
    </update>
    
</mapper>