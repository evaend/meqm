<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.phxl.ysy.dao.PackageToolMapper">

	<resultMap id="BaseResultMap" type="com.phxl.ysy.entity.PackageTool">
		<id column="PACKAGE_TOOL_GUID" property="packageToolGuid" jdbcType="VARCHAR" />
		<result column="SEND_ID" property="sendId" jdbcType="VARCHAR" />
		<result column="PACKAGE_ID" property="packageId" jdbcType="DECIMAL" />
		<result column="AMOUNT" property="amount" jdbcType="DECIMAL" />
		<result column="TOOL_CODE" property="toolCode" jdbcType="VARCHAR" />
		<result column="TOOL_NAME" property="toolName" jdbcType="VARCHAR" />
		<result column="SAVE_FLAG" property="saveFlag" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="BaseResultExtMap" type="com.phxl.ysy.entity.PackageTool" extends="BaseResultMap">
		<result column="IS_SELECTED" property="isSelected" jdbcType="DECIMAL" javaType="boolean"/>
	</resultMap>
	
	<sql id="Base_Column_List">
		dpt.PACKAGE_TOOL_GUID, dpt.SEND_ID, dpt.PACKAGE_ID, dpt.TOOL_CODE, dpt.AMOUNT, dpt.TOOL_NAME, dpt.SAVE_FLAG
	</sql>
	
	<!-- 查询指定包的工具列表（已选、未选） -->
	<select id="findAllToolsByPackageId" resultMap="BaseResultExtMap" parameterType="com.phxl.core.base.entity.Pager">
		select 
			nvl(dpt.PACKAGE_TOOL_GUID, sys_guid()),
			dpt.SEND_ID,
			dpt.PACKAGE_ID,
			nvl(tsd.TF_CLO_CODE, dpt.TOOL_CODE) TOOL_CODE,
			nvl(dpt.DRAFT_AMOUNT, dpt.AMOUNT) AMOUNT,
			nvl(dpt.TOOL_NAME, tsd.TF_CLO_NAME) TOOL_NAME,
			case when dpt.PACKAGE_TOOL_GUID is not null then 1 else 0 end IS_SELECTED
		from TB_DELIVERY_PACKAGE_TOOL dpt 
		right join TD_STATIC_DATA tsd on tsd.TF_CLO_CODE=dpt.TOOL_CODE <include refid="sendIdAndSubmitFlagScope"/> and dpt.package_id=#{conditiions.packageId,jdbcType=DECIMAL}
		inner join TD_STATIC_INFO tsi on tsi.STATIC_ID=tsd.STATIC_ID and tsi.ORG_ID=#{conditiions.rOrgId, jdbcType=DECIMAL} and tsi.TF_CLO = 'ATTRIBUTE_TOOL'
		where 1=1
		<if test="conditiions!=null">
			<if test="conditiions!=null and conditiions.toolNameLike != null and conditiions.toolNameLike != ''">
				and regexp_like(tsd.TF_CLO_NAME, #{conditiions.toolNameLike,jdbcType=VARCHAR})
			</if>
		</if>
	</select>

	<!--查找指定手术包的工具列表 -->
	<select id="findToolsByPackageId" resultMap="BaseResultMap" parameterType="com.phxl.core.base.entity.Pager">
		select
			nvl(dpt.PACKAGE_TOOL_GUID, sys_guid()), dpt.SEND_ID, dpt.PACKAGE_ID, dpt.TOOL_CODE, dpt.AMOUNT, dpt.TOOL_NAME
		from TB_DELIVERY_PACKAGE_TOOL dpt
		where 1=1
		<if test="conditiions!=null">
			<include refid="sendIdAndSubmitFlagScope"/> and dpt.package_id=#{conditiions.packageId,jdbcType=DECIMAL}
		</if>
	</select>

	<!-- 指定手术包批量添加工具 -->
	<insert id="mergeToolList4Oper">
		declare
			cntOfOperTool INT;
			draftAmountOfOperTool INT;
		BEGIN
			<!-- 添加或更新手术包工具 -->
			MERGE INTO TB_DELIVERY_PACKAGE_TOOL h
			  USING (
				SELECT send_id, package_id, TOOL_CODE, sum(AMOUNT) AMOUNT,
						(
						SELECT tsd.TF_CLO_NAME
						from TD_STATIC_INFO tsi
						LEFT JOIN TD_STATIC_DATA tsd on tsi.STATIC_ID=tsd.STATIC_ID
						WHERE tsi.ORG_ID = #{rOrgId, jdbcType=DECIMAL} and tsi.TF_CLO = 'ATTRIBUTE_TOOL' and tsd.TF_CLO_CODE=TOOL_CODE
						) TOOL_NAME
				FROM (
				    <foreach collection="toolList" item="item" separator="union all">
				      select
					      #{sendId, jdbcType=VARCHAR} SEND_ID,
					      #{item.packageId, jdbcType=DECIMAL} PACKAGE_ID,
					      #{item.toolCode, jdbcType=VARCHAR} TOOL_CODE,
					      (
							SELECT tsd.TF_CLO_NAME
							from TD_STATIC_INFO tsi
							LEFT JOIN TD_STATIC_DATA tsd on tsi.STATIC_ID=tsd.STATIC_ID
							WHERE tsi.ORG_ID = #{rOrgId, jdbcType=DECIMAL} and tsi.TF_CLO = 'ATTRIBUTE_TOOL' and tsd.TF_CLO_CODE=#{item.toolCode, jdbcType=VARCHAR}
						  ) TOOL_NAME,
					      #{item.tfAmount, jdbcType=DECIMAL} AMOUNT
				      from dual
				    </foreach>
				) GROUP BY send_id, package_id, TOOL_CODE
			  ) hp ON (h.SEND_ID=hp.SEND_ID and h.PACKAGE_ID=hp.PACKAGE_ID and h.TOOL_CODE=hp.TOOL_CODE)
			WHEN MATCHED THEN UPDATE
			SET
				 h.DRAFT_AMOUNT = hp.AMOUNT,
				 h.AMOUNT = DECODE(h.SAVE_FLAG, '00', hp.AMOUNT, h.AMOUNT),
				 h.TOOL_NAME = hp.TOOL_NAME,
				 h.SAVE_FLAG = DECODE(h.SAVE_FLAG, '01', '02', '02', '02', '03', '03', '00')
			WHEN NOT MATCHED THEN INSERT(PACKAGE_TOOL_GUID, SEND_ID, PACKAGE_ID, AMOUNT, TOOL_CODE, TOOL_NAME, SAVE_FLAG)
			VALUES (sys_guid(), hp.SEND_ID, hp.PACKAGE_ID, hp.AMOUNT, hp.TOOL_CODE,hp.TOOL_NAME, '00');

			<!-- 删除标识: 前端已经删除的手术包产品类型 -->
			UPDATE TB_DELIVERY_PACKAGE_TOOL dpt
			SET
				dpt.DRAFT_AMOUNT = NULL,
				dpt.SAVE_FLAG='03'
			WHERE dpt.SEND_ID = #{sendId, jdbcType=VARCHAR} and dpt.SAVE_FLAG in ('01','02')
			AND dpt.PACKAGE_TOOL_GUID not in (
				<foreach collection="toolList" item="item" index="index" separator="union">
					SELECT #{toolList[${index}].packageToolGuid, jdbcType=VARCHAR} PACKAGE_TOOL_GUID FROM dual
				</foreach>
			);

			<!-- 物理删除: 前端已经删除的手术包产品类型 -->
			DELETE FROM TB_DELIVERY_PACKAGE_TOOL dpt
			WHERE dpt.SEND_ID = #{sendId, jdbcType=VARCHAR} and dpt.SAVE_FLAG='00'
			AND dpt.PACKAGE_TOOL_GUID not in (
				<foreach collection="toolList" item="item" index="index" separator="union">
					SELECT #{toolList[${index}].packageToolGuid, jdbcType=VARCHAR} PACKAGE_TOOL_GUID FROM dual
				</foreach>
			);

			<!-- 更新手术器械的数量 -->
			<include refid="updateOperToolAmount"/>
		END;
	</insert>

	<!-- 更新手术器械的数量(语句片段) -->
	<sql id="updateOperToolAmount">
		SELECT count(*) into cntOfOperTool from TB_DELIVERY_PACKAGE WHERE SEND_ID=#{sendId, jdbcType=VARCHAR} and PACKAGE_ID=#{packageId, jdbcType=DECIMAL} and ATTRIBUTE_ID='operTool';
		SELECT nvl(sum(nvl(DRAFT_AMOUNT,pt.AMOUNT)),0) into draftAmountOfOperTool from TB_DELIVERY_PACKAGE_TOOL pt WHERE pt.SEND_ID=#{sendId, jdbcType=VARCHAR} and pt.PACKAGE_ID=#{packageId, jdbcType=DECIMAL} and pt.SAVE_FLAG!='03';
		if cntOfOperTool>0 then
			UPDATE TB_DELIVERY_PACKAGE
			set
				DRAFT_AMOUNT=draftAmountOfOperTool,
				AMOUNT = DECODE(SAVE_FLAG, '00', draftAmountOfOperTool, AMOUNT),
				SAVE_FLAG = DECODE(SAVE_FLAG, '01', '02', '02', '02', '03', '03', '00')
			WHERE SEND_ID=#{sendId, jdbcType=VARCHAR} and PACKAGE_ID=#{packageId, jdbcType=DECIMAL} and ATTRIBUTE_ID='operTool';
		else
			INSERT INTO TB_DELIVERY_PACKAGE tdp (tdp.PACKAGE_ATTR_GUID, tdp.SEND_ID, tdp.PACKAGE_ID, tdp.ATTRIBUTE_ID, tdp.AMOUNT, tdp.DRAFT_AMOUNT, tdp.IS_IMPLANT_FLAG, tdp.IS_TOOL_FLAG, tdp.SAVE_FLAG)
			VALUES (sys_guid, #{sendId, jdbcType=VARCHAR}, #{packageId, jdbcType=DECIMAL}, 'operTool', draftAmountOfOperTool, draftAmountOfOperTool, '00', '01', '00');
		end if;
	</sql>

	<!-- 指定手术包批量添加工具（从指定的模板手术包） -->
	<insert id="mergeToolListFromTemplatePackages">
		INSERT INTO TB_DELIVERY_PACKAGE_TOOL (PACKAGE_TOOL_GUID, SEND_ID, PACKAGE_ID, TOOL_CODE, AMOUNT, TOOL_NAME, SAVE_FLAG)

		SELECT sys_guid(), SEND_ID, PACKAGE_ID, TOOL_CODE, sum(TF_AMOUNT) AMOUNT,
			(
				SELECT tsd.TF_CLO_NAME
				from TD_STATIC_INFO tsi
				LEFT JOIN TD_STATIC_DATA tsd on tsi.STATIC_ID=tsd.STATIC_ID
				WHERE tsi.ORG_ID = #{rOrgId, jdbcType=DECIMAL} and tsi.TF_CLO = 'ATTRIBUTE_TOOL' and tsd.TF_CLO_CODE=TOOL_CODE
			) TOOL_NAME,
			'00'
		FROM (
			<foreach collection="templatePackageList" item="pt" separator="union all">
				SELECT
					#{sendId, jdbcType=VARCHAR} send_id,
					#{pt.toPackageId, jdbcType=DECIMAL} package_id,
					tpt.TOOL_CODE,
					tpt.TF_AMOUNT
				from tb_gk_template_package_tool tpt WHERE gk_template_guid=#{pt.templateGuid,jdbcType=VARCHAR} and package_id=#{pt.fromPackageId, jdbcType=DECIMAL}
			</foreach>
		) GROUP BY send_id, package_id, TOOL_CODE
	</insert>
	
	<!-- 查询指定手术包的工具数量 -->
	<select id="countToolsByPackageId" resultType="java.lang.Integer">
		select sum(amount) from tb_delivery_package_tool dpt
		where 1=1
			<include refid="sendIdAndSubmitFlagScope-II"/> and dpt.package_id=#{packageId,jdbcType=DECIMAL}
	</select>

	<!-- 指定手术包删除多个工具 -->
	<delete id="deleteToolsFromPackage">
		declare
			cntOfOperTool INT;
			draftAmountOfOperTool INT;
		BEGIN
			<!-- 删除标识: 前端已经删除的手术器械 -->
			UPDATE TB_DELIVERY_PACKAGE_TOOL dpt
			SET
				dpt.DRAFT_AMOUNT = NULL,
				dpt.SAVE_FLAG='03'
			WHERE dpt.SEND_ID = #{sendId, jdbcType=VARCHAR} and dpt.package_id=#{packageId,jdbcType=DECIMAL} and dpt.SAVE_FLAG in ('01','02')
				  and dpt.TOOL_CODE in (
					<foreach collection="toolCodes" item="toolCode" separator="union all">SELECT #{toolCode,jdbcType=VARCHAR} FROM dual </foreach>
				  );
			<!-- 物理删除: 前端已经删除的手术器械 -->
			DELETE FROM TB_DELIVERY_PACKAGE_TOOL dpt
			WHERE dpt.SEND_ID = #{sendId, jdbcType=VARCHAR} and dpt.package_id=#{packageId,jdbcType=DECIMAL} and dpt.SAVE_FLAG='00'
				  and dpt.TOOL_CODE in (
					<foreach collection="toolCodes" item="toolCode" separator="union all">SELECT #{toolCode,jdbcType=VARCHAR} FROM dual </foreach>
				  );
			<!-- 更新手术器械的数量 -->
			<include refid="updateOperToolAmount"/>
		END;
	</delete>

	<!-- 清理指定一个手术包内手术器械 -->
	<delete id="clearToolsFromPackage">
		declare
			cntOfOperTool INT;
			draftAmountOfOperTool INT;
		BEGIN
			<!-- 删除标识: 前端已经删除的手术包工具 -->
			UPDATE TB_DELIVERY_PACKAGE_TOOL dpt
			SET
				dpt.DRAFT_AMOUNT = NULL,
				dpt.SAVE_FLAG='03'
			WHERE dpt.SEND_ID=#{sendId, jdbcType=VARCHAR} and dpt.package_id=#{packageId,jdbcType=DECIMAL} and dpt.SAVE_FLAG in ('01','02');
			<!-- 物理删除: 前端已经删除的手术包工具 -->
			DELETE FROM TB_DELIVERY_PACKAGE_TOOL dpt
			WHERE dpt.SEND_ID=#{sendId, jdbcType=VARCHAR} and dpt.package_id=#{packageId,jdbcType=DECIMAL} and dpt.SAVE_FLAG='00';
			<!-- 更新手术器械的数量 -->
			<include refid="updateOperToolAmount"/>
		END;
	</delete>

	<sql id="sendIdAndSubmitFlagScope">
		and dpt.SEND_ID = #{conditiions.sendId,jdbcType=VARCHAR}
		<choose>
			<!-- 已提交备货数据 -->
			<when test='conditiions.submitFlag!=null and conditiions.submitFlag=="S"' > and dpt.SAVE_FLAG in ('01','02','03') </when>
			<!--临时备货数据-->
			<when test='conditiions.submitFlag!=null and conditiions.submitFlag=="D"' > and dpt.SAVE_FLAG in ('00', '01','02') </when>
			<otherwise>and 1=2</otherwise>
		</choose>
	</sql>

	<sql id="sendIdAndSubmitFlagScope-II">
		and dpt.SEND_ID = #{sendId,jdbcType=VARCHAR}
		<choose>
			<!-- 已提交备货数据 -->
			<when test='submitFlag!=null and submitFlag=="S"' > and dpt.SAVE_FLAG in ('01','02','03') </when>
			<!--临时备货数据-->
			<when test='submitFlag!=null and submitFlag=="D"' > and dpt.SAVE_FLAG in ('00', '01','02') </when>
			<otherwise>and 1=2</otherwise>
		</choose>
	</sql>

	<resultMap id="compareToolAmounMap" type="hashMap">
		<result column="package_id" property="packageId" jdbcType="DECIMAL" javaType="Integer"/>
		<result column="diff" property="diff" jdbcType="DECIMAL" javaType="Integer"/>
	</resultMap>

	<!-- 查看指定送货单是否有手术包工具明细 -->
	<select id="countPackageToolListBySendId" parameterType="string" resultType="Boolean">
		SELECT case when count(*)=0 THEN 0 ELSE 1 end flag from TB_DELIVERY_PACKAGE_TOOL WHERE SEND_ID=#{sendId, jdbcType=VARCHAR} AND SAVE_FLAG in ('00','01','02')
	</select>

	<!-- 核对每个手术包手术器械的数量 -->
	<select id="checkToolAmountOfOperPerPackage" resultMap="compareToolAmounMap">
		SELECT
			nvl(pp.package_id, pt.package_id) package_id,
			nvl(pp.amount, 0) - nvl(pt.amount,0) diff,
			nvl(pp.amount, 0) "汇总数量1",
			nvl(pt.amount, 0) "汇总数量2"
		FROM
		(
			<foreach collection="amountByPackage" index="index" separator="UNION ALL">
				SELECT #{amountByPackage[${index}].packageId,jdbcType=DECIMAL} package_id, #{amountByPackage[${index}].toolAmount,jdbcType=DECIMAL} amount FROM dual
			</foreach>
		) pp
		FULL JOIN (
			SELECT PACKAGE_ID, sum(NVL(DRAFT_AMOUNT,AMOUNT)) amount
			FROM tb_delivery_package_tool
			WHERE SEND_ID=#{orderId,jdbcType=VARCHAR} and SAVE_FLAG in ('00', '01','02')
			GROUP BY PACKAGE_ID
		) pt on pp.package_id=pt.PACKAGE_ID
		ORDER by package_id asc
	</select>

</mapper>