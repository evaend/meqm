<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.phxl.ysy.dao.DeptMapper">

	<resultMap id="BaseResultMap" type="com.phxl.ysy.entity.Dept">
		<id column="DEPT_GUID" property="deptGuid" jdbcType="VARCHAR" />
		<result column="ORG_ID" property="orgId" jdbcType="DECIMAL" />
		<result column="DEPT_CODE" property="deptCode" jdbcType="VARCHAR" />
		<result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR" />
		<result column="FQUN" property="fqun" jdbcType="VARCHAR" />
		<result column="PARENT_DEPT_GUID" property="parentDeptGuid" jdbcType="VARCHAR" />
		<result column="FFLAG" property="fflag" jdbcType="VARCHAR" />
		<result column="FSTATE" property="fstate" jdbcType="VARCHAR" />
		<result column="DEPT_TYPE_CODE" property="deptTypeCode" jdbcType="VARCHAR" />
		<result column="DEPT_TYPE_NAME" property="deptTypeName" jdbcType="VARCHAR" />
		<result column="TF_REMARK" property="tfRemark" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="Base_Column_List_With_Prefix">
		d.DEPT_GUID, d.ORG_ID, d.DEPT_CODE, d.DEPT_NAME, d.FQUN, d.PARENT_DEPT_GUID, d.FFLAG, d.FSTATE,
		d.DEPT_TYPE_CODE, d.DEPT_TYPE_NAME,
		d.TF_REMARK
	</sql>
	<sql id="Base_Column_List_With_YYPrefix"> 
		vd."sourceDept" sourceDept,
		vd."auditApply" auditApply, 
		vd."auditGzApply" auditGzApply, 
		vd."auditSsApply" auditSsApply
	</sql>
	
	<!-- 查询科室列表（联想下拉搜索） -->
	<select id="findDeptListForSelector" resultType="java.util.LinkedHashMap" parameterType="com.phxl.core.base.entity.Pager">
		SELECT
		  DISTINCT d.DEPT_GUID "value", d.DEPT_NAME "text"
		FROM  TD_ORG_DEPT d
		WHERE d.FSTATE='01'
		<if test="conditiions!=null">
			<!-- 指定机构体系 -->
			and d.ORG_ID = #{conditiions.orgId, jdbcType=DECIMAL}
			<if test="conditiions.searchName!=null and conditiions.searchName!=''">
				and regexp_like(d.DEPT_NAME, #{conditiions.searchName, jdbcType=VARCHAR})
			</if>
		</if>
	</select>
	<resultMap id="BaseExtResultMap" type="com.phxl.ysy.entity.Dept" extends="BaseResultMap">
		<result column="sourceDept" property="sourceDept" jdbcType="VARCHAR" />
		<result column="auditApply" property="auditApply" jdbcType="VARCHAR" />
		<result column="auditGzApply" property="auditGzApply" jdbcType="VARCHAR" />
		<result column="auditSsApply" property="auditSsApply" jdbcType="VARCHAR" />	
		<result column="DEFAULT_ADDRES" property="defaultAddress" jdbcType="VARCHAR" />	
	</resultMap>
	<!-- 查询带参数的科室 -->
	<select id="findDeptWithConfig" resultMap="BaseExtResultMap" parameterType="string">
	     select <include refid="Base_Column_List_With_Prefix"></include>,
		     <include refid="Base_Column_List_With_YYPrefix"></include>,
			  a.tf_address DEFAULT_ADDRES
		from td_org_dept d 
	  	left join V_DEPTCONFIG vd on d.dept_guid = vd.dept_guid
	  	left join TD_ADDRESSES a on a.tf_clo_guid = d.dept_guid and a.addr_table = 'TD_ORG_DEPT' and a.is_default = '01'
		WHERE d.dept_guid = #{deptGuid} 		
	</select>
	
	<select id="searchDeptInfoList" resultMap="BaseExtResultMap" parameterType="com.phxl.core.base.entity.Pager">
	  select <include refid="Base_Column_List_With_Prefix"></include>,
	  <if test="conditiions.configCode!=null and conditiions.configCode =='deptConfigYY'">
	  		<include refid="Base_Column_List_With_YYPrefix"></include>,				
	  </if>
	  a.tf_address DEFAULT_ADDRES
	  from td_org_dept d 
	  left join V_DEPTCONFIG vd on d.dept_guid = vd.dept_guid
	  left join TD_ADDRESSES a on a.tf_clo_guid = d.dept_guid and a.addr_table = 'TD_ORG_DEPT' and a.is_default = '01'
	  where d.ORG_ID = #{conditiions.orgId, jdbcType=DECIMAL}
	  <if test="conditiions != null and conditiions.searchName != null and conditiions.searchName != ''">
		and (<![CDATA[regexp_like(d.DEPT_NAME, #{conditiions.searchName, jdbcType=VARCHAR}) ]]>
		    or  <![CDATA[regexp_like(d.FQUN, #{conditiions.searchName, jdbcType=VARCHAR}) ]]>
		    or  <![CDATA[regexp_like(d.DEPT_CODE, #{conditiions.searchName, jdbcType=VARCHAR}) ]]>
		    
		)
	  </if>
	  <if test="conditiions != null and conditiions.fstate != null and conditiions.fstate != '-1'">
		and d.FSTATE = #{conditiions.fstate, jdbcType=VARCHAR}
	  </if>
	  <choose>
		   <when test="conditiions != null and conditiions.sortCol!= null and conditiions.sortCol != ''">
		    order by ${conditiions.sortCol} ${conditiions.sortType}
		   </when>
		   <otherwise>
		    order by d.DEPT_NAME ASC 
		   </otherwise>
	  </choose> 
    </select>
    
    <select id="searchDeptAddress" resultType="HashMap" parameterType="com.phxl.core.base.entity.Pager">
	  select ADDR_GUID "addrGuid",ADDR_GUID "key",LINKMAN "linkman",LINKTEL "linktel",TF_ADDRESS "tfAddress",(case when IS_DEFAULT = '01' then 1 else 0 end) "isDefault" from TD_ADDRESSES
      where ADDR_TABLE = 'TD_ORG_DEPT' and TF_CLO_GUID = #{conditiions.deptGuid, jdbcType=VARCHAR}
      order by IS_DEFAULT desc
    </select>
    
    <delete id="deleteDeptLocations">
		DELETE FROM TD_ADDRESSES WHERE ADDR_TABLE = 'TD_ORG_DEPT' and TF_CLO_GUID = #{deptGuid, jdbcType=VARCHAR}
	</delete>
	
	<delete id="deleteDeptUsers" >
		DELETE FROM TD_DEPT_USER WHERE DEPT_GUID = #{deptGuid}
	</delete>
	
	<delete id="deleteDeptAddressById" >
		DELETE FROM td_addresses d WHERE d.addr_guid in (
		  select distinct t.addr_guid from td_addresses t
		  where t.tf_clo_guid = #{deptGuid, jdbcType=VARCHAR} and t.addr_table = 'TD_ORG_DEPT'
		  <if test="addrGuidList!=null and !addrGuidList.empty">
		    and t.addr_guid not in
		    <foreach collection="addrGuidList" index="index" open="(" close=")" separator=",">
			     #{addrGuidList[${index}], jdbcType=VARCHAR}
			</foreach>
		  </if>
		)
	</delete>
	
	<select id="findDeptCodeExist" resultType="int">
	     select COUNT(1) from TD_ORG_DEPT where ORG_ID = #{sessionOrgId, jdbcType=DECIMAL} and DEPT_CODE = #{deptCode, jdbcType=VARCHAR}
    </select>
    
    <resultMap id="UserInfoExtResultMap" type="com.phxl.ysy.entity.UserInfo" 
				extends="com.phxl.ysy.dao.UserInfoMapper.BaseResultMap">
		<result column="is_selected" property="selected" jdbcType="DECIMAL"/>
	</resultMap>
    
    <select id="searchDeptUsers" resultMap="UserInfoExtResultMap">
		SELECT
		  u.USER_ID, u.USER_NO, u.USER_NAME, u.PWD, u.FSTATE, u.TF_REMARK, u.MODIFY_TIME, u.CREATE_TIME,
		  u.CREATE_USERID, u.MODIFY_USERID, u.USER_LEVEL, u.MOBILE_PHONE, u.E_MAIL, u.QQ,
		  u.ORG_ID, u.WECHAT_OPENID, u.WECHAT_NO, u.ORG_TYPE, u.JOB_NUM,
		  CASE WHEN du.USER_ID IS NOT NULL THEN 1 ELSE 0 END is_selected
		FROM TD_ORG_DEPT d
		JOIN TD_DEPT_USER du ON d.dept_guid = #{deptGuid, jdbcType=VARCHAR} and d.dept_guid = du.dept_guid
        RIGHT JOIN TS_USER_INFO u ON du.USER_ID = u.USER_ID
		where u.ORG_ID = #{sessionOrgId, jdbcType=DECIMAL}
		ORDER BY u.USER_NAME ASC
	 </select>
	 
	<resultMap type="hashMap" id="DeptSelecter">
		<result column="DEPT_GUID" property="deptGuid" jdbcType="VARCHAR" />
	 	<result column="DEPT_GUID" property="value" jdbcType="VARCHAR" />
		<result column="DEPT_NAME" property="label" jdbcType="VARCHAR" />
	 </resultMap> 
	 
	 <resultMap id="BaseResultWithAssoMap" type="hashMap" extends="DeptSelecter">
		<association property="children" column="deptGuid"
			select="selectStorageListByDeptGuid"></association>
	</resultMap>
	 
	 <!-- 查询当前登录的用户所属的科室列表（下拉框） -->
	<select id="findDeptsByUser" resultMap="BaseResultWithAssoMap" parameterType="com.phxl.core.base.entity.Pager">
		SELECT
		  DISTINCT du.DEPT_GUID "deptGuid",du.DEPT_GUID "value", od.DEPT_NAME "label"
		FROM  TD_DEPT_USER du,TD_ORG_DEPT od
		WHERE  du.DEPT_GUID =  od.DEPT_GUID and od.FSTATE='01'
			   and od.org_id = #{conditiions.orgId}
			   and du.USER_ID = #{conditiions.userId}
		<if test="conditiions.searchParams!=null and conditiions.searchParams!=''">
			and regexp_like(od.DEPT_NAME, #{conditiions.searchParams, jdbcType=VARCHAR})
		</if>		
	</select>
	
	<select id="selectStorageListByDeptGuid" resultType="hashMap" parameterType="String">
		SELECT
		  DISTINCT sg.STORAGE_GUID "value", sg.STORAGE_NAME "label"
		FROM  TD_STORAGE_OPEN_DEPT sod,TD_STORAGE_INFO sg
		WHERE  sod.STORAGE_GUID=sg.STORAGE_GUID and sg.FSTATE='01'
	   		and sod.DEPT_GUID= #{deptGuid}
	</select>

	<!-- 查询指定科室的地址列表（下拉列表：联想搜索） -->
	<select id="searchAddrListByDeptGuid" resultType="map">
		SELECT 
			ADDR_GUID "value", 
			TF_ADDRESS || ' | ' || LINKMAN || ' | ' || LINKTEL "text", 
			CASE WHEN IS_DEFAULT = '01' THEN 1 ELSE 0 END as "isDefault" 
		FROM TD_ADDRESSES a 
		WHERE a.TF_CLO_GUID=#{deptGuid, jdbcType=VARCHAR}
		<if test="searchName!=null and searchName!=''">
			and regexp_like(a.TF_ADDRESS, #{searchName, jdbcType=VARCHAR})
		</if>
		order by IS_DEFAULT desc, TF_ADDRESS 
	</select>
	
	<resultMap type="hashMap" id="LoginOrgDept">
	 	<result column="DEPT_GUID" property="value" jdbcType="VARCHAR" />
		<result column="DEPT_NAME" property="text" jdbcType="VARCHAR" />
	 </resultMap> 
	
	<!-- 查询当前登录用户的机构下所有的科室 -->
	<select id="selectLoginOrgDept" resultMap="LoginOrgDept" parameterType="com.phxl.core.base.entity.Pager">
		select DEPT_GUID "value" , DEPT_NAME "text" from td_org_dept where org_id = #{conditiions.orgId, jdbcType=VARCHAR}
	</select>
	
</mapper>