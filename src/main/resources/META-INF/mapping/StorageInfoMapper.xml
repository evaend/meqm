<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.phxl.ysy.dao.StorageInfoMapper">

	<resultMap id="BaseResultMap" type="com.phxl.ysy.entity.StorageInfo">
		<id column="STORAGE_GUID" property="storageGuid" jdbcType="VARCHAR" />
		<result column="ORG_ID" property="orgId" jdbcType="DECIMAL" />
		<result column="STORAGE_CODE" property="storageCode" jdbcType="VARCHAR" />
		<result column="STORAGE_NAME" property="storageName" jdbcType="VARCHAR" />
		<result column="FSTATE" property="fstate" jdbcType="VARCHAR" />
		<result column="TF_REMARK" property="tfRemark" jdbcType="VARCHAR" />			
	</resultMap>
	
	<sql id="Base_Column_List">
		STORAGE_GUID, ORG_ID, STORAGE_CODE, STORAGE_NAME,TF_REMARK
	</sql>
	
	<sql id="Base_Column_List_With_Prefix">
		sg.STORAGE_GUID, sg.ORG_ID, sg.STORAGE_CODE, sg.STORAGE_NAME, sg.FSTATE,sg.TF_REMARK
	</sql>
	
	<sql id="Base_Column_List_With_YYPrefix"> 
		vs."storageLevelCode" STORAGE_LEVEL_CODE,
		vs."storageSourceType" STORAGE_SOURCE_TYPE, 
		vs."openFlag" OPEN_FLAG, vs."sourceStorageGuid" SOURCE_STORAGE_GUID,
		vs."deptGuid" DEPT_GUID,vs."jsfs" JSFS,vs."shfs" SHFS,
		vs."qrFlag" QR_FLAG,
		vs."parentStorageGuid" PARENT_STORAGE_GUID
	</sql>
	
	<sql id="Base_Column_List_With_KHPrefix"> 
		vs."isAutoApply" isAutoApply,
		vs."isAutoGzss" isAutoGzss, 
		vs."isAutoSsApply" isAutoSsApply, 
		vs."applyHandlePerson" applyHandlePerson,
		vs."gzssHandlePerson" gzssHandlePerson,
		vs."ssApplyHandlePerson" ssApplyHandlePerson
	</sql>
	
	<resultMap id="BaseExtResultMap" type="com.phxl.ysy.entity.StorageInfo" extends="BaseResultMap">
		<result column="ORG_NAME" property="orgName" jdbcType="VARCHAR" />
		<result column="PARENT_STORAGE_NAME" property="parentStorageName" jdbcType="VARCHAR" />
		<result column="SOURCE_STORAGE_NAME" property="sourceStorageName" jdbcType="VARCHAR" />
		<result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR" />
		<result column="PARENT_STORAGE_GUID" property="parentStorageGuid" jdbcType="VARCHAR" />
		<result column="STORAGE_LEVEL_CODE" property="storageLevelCode" jdbcType="VARCHAR" />
		<result column="STORAGE_FTYPE_CODE" property="storageFtypeCode" jdbcType="VARCHAR" />
		<result column="FSTATE" property="fstate" jdbcType="VARCHAR" />
		<result column="OPEN_FLAG" property="openFlag" jdbcType="VARCHAR" />
		<result column="STORAGE_SOURCE_TYPE" property="storageSourceType" jdbcType="VARCHAR" />
		<result column="SOURCE_STORAGE_GUID" property="sourceStorageGuid" jdbcType="VARCHAR" />
		<result column="DEPT_GUID" property="deptGuid" jdbcType="VARCHAR" />
		<result column="isAutoApply" property="isAutoApply" jdbcType="VARCHAR" />
		<result column="isAutoGzss" property="isAutoGzss" jdbcType="VARCHAR" />
		<result column="isAutoSsApply" property="isAutoSsApply" jdbcType="VARCHAR" />
		<result column="applyHandlePerson" property="applyHandlePerson" jdbcType="VARCHAR" />
		<result column="gzssHandlePerson" property="gzssHandlePerson" jdbcType="VARCHAR" />
		<result column="ssApplyHandlePerson" property="ssApplyHandlePerson" jdbcType="VARCHAR" />
		<result column="applyHandlePersonName" property="applyHandlePersonName" jdbcType="VARCHAR" />
		<result column="gzssHandlePersonName" property="gzssHandlePersonName" jdbcType="VARCHAR" />
		<result column="ssApplyHandlePersonName" property="ssApplyHandlePersonName" jdbcType="VARCHAR" />
		<result column="DEFAULT_ADDRES" property="defaultAddress" jdbcType="VARCHAR" />	
		<result column="QR_FLAG" property="qrFlag" jdbcType="VARCHAR" />
	</resultMap>
	
	<select id="findStorageWithConfig" resultMap="BaseExtResultMap" parameterType="string">
	     select <include refid="Base_Column_List_With_Prefix"></include>,
		     <include refid="Base_Column_List_With_YYPrefix"></include>,
		     <include refid="Base_Column_List_With_KHPrefix"></include>,
		      ps.STORAGE_NAME PARENT_STORAGE_NAME, 
			  a.tf_address DEFAULT_ADDRES
		from TD_STORAGE_INFO sg
		left join V_STORAGECONFIG vs on sg.STORAGE_GUID = vs.STORAGE_GUID
		left join td_storage_info ps on vs."parentStorageGuid" = ps.STORAGE_GUID
		left join TD_ADDRESSES a on a.tf_clo_guid = sg.STORAGE_GUID and a.is_default = '01'
		WHERE sg.storage_guid = #{storageGuid} 		
	</select>
	
	<!-- 根据条件，查询库房列表 -->
	<select id="queryStorageList" resultMap="BaseExtResultMap" parameterType="com.phxl.core.base.entity.Pager">
		SELECT
			<include refid="Base_Column_List_With_Prefix"></include>,
			<if test="conditiions.configCode!=null and conditiions.configCode =='storageConfigYY'">
				<include refid="Base_Column_List_With_YYPrefix"></include>,	
				ssg.storage_name SOURCE_STORAGE_NAME,
		        d.DEPT_NAME,			
			</if>
			<if test="conditiions.configCode!=null and conditiions.configCode =='storageConfigKH'">
				<include refid="Base_Column_List_With_KHPrefix"></include>,				
			</if>
			 ps.STORAGE_NAME PARENT_STORAGE_NAME,
			 a.tf_address DEFAULT_ADDRES,
			 u1.user_name applyHandlePersonName,
			 u2.user_name gzssHandlePersonName,
			 u3.user_name ssApplyHandlePersonName
		from TD_STORAGE_INFO sg
		left join V_STORAGECONFIG vs on sg.STORAGE_GUID = vs.STORAGE_GUID
		left join td_storage_info ps on vs."parentStorageGuid" = ps.STORAGE_GUID
		LEFT JOIN TD_STORAGE_INFO ssg on vs."sourceStorageGuid" = ssg.STORAGE_GUID
		LEFT JOIN TD_ORG_DEPT d on vs."deptGuid"=d.DEPT_GUID
		LEFT JOIN TS_USER_INFO u1 on vs."applyHandlePerson" = u1.user_id
		LEFT JOIN TS_USER_INFO u2 on vs."gzssHandlePerson" = u2.user_id
		LEFT JOIN TS_USER_INFO u3 on vs."ssApplyHandlePerson" = u3.user_id
		left join TD_ADDRESSES a on a.tf_clo_guid = sg.STORAGE_GUID and a.is_default = '01'
		WHERE 1=1
		<if test="conditiions!=null">
			<if test="conditiions.orgId!=null">
				and sg.ORG_ID = #{conditiions.orgId, jdbcType=VARCHAR}
			</if>
			<!-- <if test="conditiions.storageLevelCode!=null and conditiions.storageLevelCode!=''">
				and sg.STORAGE_LEVEL_CODE = #{conditiions.storageLevelCode, jdbcType=VARCHAR}
			</if>
			<if test="conditiions.orgNameLike!=null and conditiions.orgNameLike!=''">
				and ( regexp_like(org.ORG_NAME, #{conditiions.orgNameLike, jdbcType=VARCHAR})
						or regexp_like(org.FQUN, upper(#{conditiions.orgNameLike, jdbcType=VARCHAR})) )
			</if> -->
			<if test="conditiions.searchName!=null and conditiions.searchName!=''">
				and ( regexp_like(sg.STORAGE_NAME, #{conditiions.searchName, jdbcType=VARCHAR})
						or regexp_like(sg.STORAGE_CODE, #{conditiions.searchName, jdbcType=VARCHAR}) )				
			</if>
		</if>
		
		<!-- 排序 -->
		<choose>
			<when test="conditiions != null and conditiions.orderMark != null and conditiions.orderField != null and conditiions.orderField!=''">
				order by [orderField] ${conditiions.orderMark}
			</when>
			<otherwise>
				order by STORAGE_NAME asc
			</otherwise>
		</choose>
	</select>
	
	<!-- 查询库房列表（联想下拉搜索） -->
	<select id="findStorageListForSelector" resultType="java.util.LinkedHashMap" parameterType="com.phxl.core.base.entity.Pager">
		SELECT
		  DISTINCT sg.STORAGE_GUID "value", sg.STORAGE_NAME "text"
		FROM  TD_STORAGE_INFO sg
		left join V_STORAGECONFIG vs on sg.STORAGE_GUID = vs.STORAGE_GUID
		WHERE sg.FSTATE='01'
		<if test="conditiions!=null">
			<!-- 指定机构体系 -->
			<choose>
				<when test='conditiions.scopeType!=null and conditiions.scopeType=="hierarchy"'>
					and sg.ORG_ID in ( 
						SELECT o.ORG_ID FROM TD_ORG_INFO o 
						WHERE LEVEL &lt;=6 CONNECT BY nocycle o.ORG_ID = PRIOR o.PARENT_ORGID START WITH o.ORG_ID = #{conditiions.orgId, jdbcType=VARCHAR} )
				</when>
				<otherwise>and sg.ORG_ID = #{conditiions.orgId, jdbcType=DECIMAL}</otherwise>
			</choose>
			<!-- 库房级别 -->
			<if test="conditiions.levels!=null and conditiions.levels.length>0">
				and vs."storageLevelCode" in  
				<foreach collection="conditiions.levels" item="item" index="index" open="(" close=")" separator=",">
					#{conditiions.levels[${index}], jdbcType=VARCHAR}
				</foreach>
			</if>
			<!-- 库房级别 -->
			<if test="conditiions.sourceTypes!=null and conditiions.sourceTypes.length>0">
				and vs."storageSourceType" in 
				<foreach collection="conditiions.sourceTypes" item="item" index="index" open="(" close=")" separator=",">
					#{conditiions.sourceTypes[${index}], jdbcType=VARCHAR}
				</foreach>
			</if>
			<if test="conditiions.searchName!=null and conditiions.searchName!=''">
				and regexp_like(sg.STORAGE_NAME, #{conditiions.searchName, jdbcType=VARCHAR})
			</if>
			<if test="conditiions.storageGuidOfFind!=null and conditiions.storageGuidOfFind!=''">
				and sg.STORAGE_GUID = #{conditiions.storageGuidOfFind, jdbcType=VARCHAR}
			</if>
			<if test="conditiions.excludeStorageGuid!=null and conditiions.excludeStorageGuid!=''">
				and sg.STORAGE_GUID != #{conditiions.excludeStorageGuid, jdbcType=VARCHAR}
			</if>
		</if>
	</select>
	
	<!-- 判断某机构是否存在某个库房编号 -->
	<select id="existStorageCode" resultType="Boolean">
		SELECT case when count(*)=0 THEN 0 ELSE 1 end flag FROM TD_STORAGE_INFO sg 
		WHERE sg.ORG_ID = #{orgId, jdbcType=DECIMAL} and STORAGE_CODE = #{storageCode, jdbcType=VARCHAR}
	</select>
	
	
	<resultMap type="java.util.HashMap" id="LoginOrgStorage">
		<result column="STORAGE_GUID" property="value" jdbcType="VARCHAR"/>
		<result column="STORAGE_NAME" property="text" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 查询当前登录用户的机构下的所有的库房 -->
	<select id="selectLoginOrgStorage" resultMap="LoginOrgStorage" parameterType="com.phxl.core.base.entity.Pager">
		select STORAGE_GUID "value" , STORAGE_NAME "text" from td_storage_info where org_id = #{conditiions.orgId, jdbcType=VARCHAR}
	</select>

	<!-- 查找指定库房所属的大库房 -->
	<select id="findRootByStorageGuid" resultType="string" parameterType="string">
		SELECT decode(sgc."storageLevelCode", '01', sg.STORAGE_GUID, (
			SELECT sgc0."parentStorageGuid"
			FROM TD_STORAGE_INFO sg0
			LEFT JOIN V_STORAGECONFIG sgc0 on sg0.STORAGE_GUID=sgc0.STORAGE_GUID
			WHERE sg0.STORAGE_GUID=sg.STORAGE_GUID
		)) root_storage_guid
  		FROM TD_STORAGE_INFO sg
  		LEFT JOIN V_STORAGECONFIG sgc on sg.STORAGE_GUID=sgc.STORAGE_GUID
  		WHERE sg.STORAGE_GUID = #{storageGuid,jdbcType=VARCHAR}
	</select>

</mapper>